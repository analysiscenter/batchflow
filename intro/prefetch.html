

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inter-batch parallelism &mdash; BatchFlow 0.9.3 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=ba56f93a" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=0e439607"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Working with models" href="models.html" />
    <link rel="prev" title="Within batch parallelism" href="parallel.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            BatchFlow
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">A short introduction</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="classes.html">Classes and capabilities</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="dsindex.html">Index</a></li>
<li class="toctree-l2"><a class="reference internal" href="dataset.html">Dataset</a></li>
<li class="toctree-l2"><a class="reference internal" href="batch.html">Batch class</a></li>
<li class="toctree-l2"><a class="reference internal" href="images_batch.html">Batch class for handling images</a></li>
<li class="toctree-l2"><a class="reference internal" href="pipeline.html">Pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="named_expr.html">Named expressions</a></li>
<li class="toctree-l2"><a class="reference internal" href="parallel.html">Within batch parallelism</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Inter-batch parallelism</a></li>
<li class="toctree-l2"><a class="reference internal" href="models.html">Working with models</a></li>
<li class="toctree-l2"><a class="reference internal" href="torch_models.html">Torch models</a></li>
<li class="toctree-l2"><a class="reference internal" href="research.html">Research</a></li>
<li class="toctree-l2"><a class="reference internal" href="model_zoo.html">Model zoo</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../api/batchflow.html">API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">BatchFlow</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="classes.html">Classes and capabilities</a></li>
      <li class="breadcrumb-item active">Inter-batch parallelism</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/intro/prefetch.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="inter-batch-parallelism">
<h1>Inter-batch parallelism<a class="headerlink" href="#inter-batch-parallelism" title="Link to this heading"></a></h1>
<p>For long-running <a class="reference internal" href="pipeline.html"><span class="doc">pipelines</span></a> you might employ a <cite>prefetch</cite> feature which allows for a parallel batch processing.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">some_pipeline</span><span class="o">.</span><span class="n">gen_batch</span><span class="p">(</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">prefetch</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>This line states that 3 additional batches should be processed in the background.
Take into account that all the batches will be processed simultaneously without any prioritization.
However, the order of batches is preserved, i.e. batch #2 would be returned after batch #1 even if all the actions for batch #2 finished earlier. This statement is correct even for shuffled order (though it might seem illogical to some people).</p>
<p>Let’s look at an example. Here is a simple pipeline:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">some_pipeline</span> <span class="o">=</span> <span class="n">some_dataset</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">action1</span><span class="p">()</span><span class="o">.</span><span class="n">action2</span><span class="p">()</span><span class="o">.</span><span class="n">action3</span><span class="p">()</span>
</pre></div>
</div>
<p>At first, we run it without <cite>prefetch</cite>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">some_pipeline</span><span class="o">.</span><span class="n">gen_batch</span><span class="p">(</span><span class="n">BATCH_SIZE</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>The execution sequence will look as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">batch</span> <span class="c1">#1 is created</span>
    <span class="n">action</span> <span class="mi">1</span> <span class="n">started</span>
    <span class="n">action</span> <span class="mi">1</span> <span class="n">finished</span>
    <span class="n">action</span> <span class="mi">2</span> <span class="n">started</span>
    <span class="n">action</span> <span class="mi">2</span> <span class="n">finished</span>
    <span class="n">action</span> <span class="mi">3</span> <span class="n">started</span>
    <span class="n">action</span> <span class="mi">3</span> <span class="n">finished</span>
<span class="n">batch</span> <span class="c1">#2 is created</span>
    <span class="n">action</span> <span class="mi">1</span> <span class="n">started</span>
    <span class="n">action</span> <span class="mi">1</span> <span class="n">finished</span>
    <span class="n">action</span> <span class="mi">2</span> <span class="n">started</span>
    <span class="n">action</span> <span class="mi">2</span> <span class="n">finished</span>
    <span class="n">action</span> <span class="mi">3</span> <span class="n">started</span>
    <span class="n">action</span> <span class="mi">3</span> <span class="n">finished</span>
<span class="n">batch</span> <span class="c1">#3 is created</span>
    <span class="n">action</span> <span class="mi">1</span> <span class="n">started</span>
    <span class="n">action</span> <span class="mi">1</span> <span class="n">finished</span>
    <span class="n">action</span> <span class="mi">2</span> <span class="n">started</span>
    <span class="n">action</span> <span class="mi">2</span> <span class="n">finished</span>
    <span class="n">action</span> <span class="mi">3</span> <span class="n">started</span>
    <span class="n">action</span> <span class="mi">3</span> <span class="n">finished</span>
</pre></div>
</div>
<p>So, all the batches start one after another, and all the actions also start one after another.</p>
<p>Now use <cite>prefetch</cite>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">some_pipeline</span><span class="o">.</span><span class="n">gen_batch</span><span class="p">(</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">prefetch</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>This changes the execution sequence dramatically:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">batch</span> <span class="c1">#1 is created</span>
<span class="n">batch</span> <span class="c1">#2 is created</span>
    <span class="n">action</span> <span class="mi">1</span> <span class="n">started</span> <span class="k">for</span> <span class="n">batch</span> <span class="c1">#1</span>
    <span class="n">action</span> <span class="mi">1</span> <span class="n">started</span> <span class="k">for</span> <span class="n">batch</span> <span class="c1">#2</span>
    <span class="n">action</span> <span class="mi">1</span> <span class="n">finished</span> <span class="k">for</span> <span class="n">batch</span> <span class="c1">#1</span>
    <span class="n">action</span> <span class="mi">2</span> <span class="n">started</span> <span class="k">for</span> <span class="n">batch</span> <span class="c1">#1</span>
    <span class="n">action</span> <span class="mi">1</span> <span class="n">finished</span> <span class="k">for</span> <span class="n">batch</span> <span class="c1">#2</span>
    <span class="n">action</span> <span class="mi">2</span> <span class="n">started</span> <span class="k">for</span> <span class="n">batch</span> <span class="c1">#2</span>
    <span class="n">action</span> <span class="mi">2</span> <span class="n">finished</span> <span class="k">for</span> <span class="n">batch</span> <span class="c1">#1</span>
    <span class="n">action</span> <span class="mi">3</span> <span class="n">started</span> <span class="k">for</span> <span class="n">batch</span> <span class="c1">#1</span>
    <span class="n">action</span> <span class="mi">2</span> <span class="n">finished</span> <span class="k">for</span> <span class="n">batch</span> <span class="c1">#2</span>
    <span class="n">action</span> <span class="mi">3</span> <span class="n">started</span> <span class="k">for</span> <span class="n">batch</span> <span class="c1">#2</span>
    <span class="n">action</span> <span class="mi">3</span> <span class="n">finished</span> <span class="k">for</span> <span class="n">batch</span> <span class="c1">#1</span>
<span class="n">batch</span> <span class="c1">#3 is created</span>
    <span class="n">action</span> <span class="mi">1</span> <span class="n">started</span> <span class="k">for</span> <span class="n">batch</span> <span class="c1">#3</span>
    <span class="n">action</span> <span class="mi">3</span> <span class="n">finished</span> <span class="k">for</span> <span class="n">batch</span> <span class="c1">#2 &lt;-- after that batch #4 could start</span>
    <span class="n">action</span> <span class="mi">1</span> <span class="n">finished</span> <span class="k">for</span> <span class="n">batch</span> <span class="c1">#3</span>
    <span class="n">action</span> <span class="mi">2</span> <span class="n">started</span> <span class="k">for</span> <span class="n">batch</span> <span class="c1">#3</span>
    <span class="n">action</span> <span class="mi">2</span> <span class="n">finished</span> <span class="k">for</span> <span class="n">batch</span> <span class="c1">#3</span>
    <span class="n">action</span> <span class="mi">3</span> <span class="n">started</span> <span class="k">for</span> <span class="n">batch</span> <span class="c1">#3</span>
    <span class="n">action</span> <span class="mi">3</span> <span class="n">finished</span> <span class="k">for</span> <span class="n">batch</span> <span class="c1">#3</span>
</pre></div>
</div>
<p>Batch #2 is created immediately after batch #1. Then all the actions are executed for all running batches.
As actions execution time might vary between batches, the actual sequence might look different in your case.</p>
<p>However, the main principle remains the same - <cite>prefetch</cite> parameter indicates how many additional batches should be processed in advance, before you need them. As a consequence, when you need them, they will be returned much faster or even almost immediately (if all the actions have been executed already).</p>
<p>You can use <cite>prefetch</cite> in <cite>next_batch</cite>, <cite>gen_batch</cite> and <cite>run</cite>.</p>
<section id="blocked-method">
<h2>Blocked method<a class="headerlink" href="#blocked-method" title="Link to this heading"></a></h2>
<p>Sometimes you might want to guarantee that only one call of a specific action is executed simultaneously, e.g. due to a race condition or dependence on some external resources. To make this happen provide a lock to an action:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyBatch</span><span class="p">(</span><span class="n">Batch</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="nd">@action</span><span class="p">(</span><span class="n">use_lock</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">only_one</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="o">...</span>
    <span class="o">...</span>

    <span class="nd">@action</span><span class="p">(</span><span class="n">use_lock</span><span class="o">=</span><span class="s2">&quot;unique_lock_name&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">also_one</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="o">...</span>
</pre></div>
</div>
<p>Thus, whenever you make prefetching, only one batch at a time will execute <cite>only_one</cite> action.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="parallel.html" class="btn btn-neutral float-left" title="Within batch parallelism" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="models.html" class="btn btn-neutral float-right" title="Working with models" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017-2021, Analysis Center.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>